Description: GWLB POC

Parameters:
  # Input for all VPCs
  EC2KEY:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
    Type: 'AWS::EC2::KeyPair::KeyName'
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  Arm64AmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Description: This SSM parameter will have latest AMI image, just keep default and DO NOT modify it.
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-arm64-gp2'
  ApplicationServerInstanceType:
    Description: Choose instance type for application server in private subnet 
    Type: String
    Default: t4g.micro
    AllowedValues:
      - t4g.micro
      - t4g.small
      - c6g.medium
    ConstraintDescription: must be a valid EC2 instance type.
  # Input for VPC1
  WindowsAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Description: This SSM parameter will have latest AMI image, just keep default and DO NOT modify it.
    Default: '/aws/service/ami-windows-latest/Windows_Server-2019-English-Full-Base'
  VirtualApplianceServerInstanceType:
    Description: Choose instance type for virtual appliance server.
    Type: String
    Default: t4g.small
    AllowedValues:
      - t4g.micro
      - t4g.small
      - c6g.medium
    ConstraintDescription: must be a valid EC2 instance type.
  JumpServerInstanceType:
    Description: Choose instance type for jumpserver
    Type: String
    Default: t3.large
    AllowedValues:
      - t3.large
      - t3.xlarge
    ConstraintDescription: must be a valid EC2 instance type.
  JumpServerAllowList:
    Description: Please enter the CIDR that allows to connect to JumpServer
    Type: String
    Default: 52.82.200.0/24
  VPC1CIDR:
    Description: Please enter the IP range (CIDR notation) for this VPC
    Type: String
    Default: 10.1.0.0/16
  VPC1NATSubnet1CIDR:
    Description: Please enter the IP range (CIDR notation) for the public subnet in the first Availability Zone
    Type: String
    Default: 10.1.1.0/24
  VPC1NATSubnet2CIDR:
    Description: Please enter the IP range (CIDR notation) for the public subnet in the second Availability Zone
    Type: String
    Default: 10.1.2.0/24
  VPC1ApplianceSubnet1CIDR:
    Description: Please enter the IP range (CIDR notation) for the private subnet in the first Availability Zone
    Type: String
    Default: 10.1.101.0/24
  VPC1ApplianceSubnet2CIDR:
    Description: Please enter the IP range (CIDR notation) for the private subnet in the second Availability Zone
    Type: String
    Default: 10.1.102.0/24
  VPC1PrivateSubnet1CIDR:
    Description: Please enter the IP range (CIDR notation) for the private subnet in the first Availability Zone
    Type: String
    Default: 10.1.201.0/24
  VPC1PrivateSubnet2CIDR:
    Description: Please enter the IP range (CIDR notation) for the private subnet in the second Availability Zone
    Type: String
    Default: 10.1.202.0/24

Resources:
  # SSM Role
  SSMStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://my-ab-demo.s3-ap-southeast-1.amazonaws.com/GWLB/single-vpc-cn/Nested-SSMRole.yml
      TimeoutInMinutes: 5
      Tags:
        - Key: Name
          Value: SSMRole

  # Access VPC (VPC1)
  VPC01Stack:
    Type: AWS::CloudFormation::Stack
    DependsOn: SSMStack
    Properties:
      Parameters:
        SSMIAMRole: !GetAtt SSMStack.Outputs.SSMRole
        EC2KEY: !Ref EC2KEY
        Arm64AmiId: !Ref Arm64AmiId
        WindowsAmiId: !Ref WindowsAmiId
        JumpServerInstanceType: !Ref JumpServerInstanceType
        VirtualApplianceServerInstanceType: !Ref VirtualApplianceServerInstanceType
        JumpServerAllowList: !Ref JumpServerAllowList
        VPC1CIDR: !Ref VPC1CIDR
        VPC1NATSubnet1CIDR: !Ref VPC1NATSubnet1CIDR
        VPC1NATSubnet2CIDR: !Ref VPC1NATSubnet2CIDR
        VPC1ApplianceSubnet1CIDR: !Ref VPC1ApplianceSubnet1CIDR
        VPC1ApplianceSubnet2CIDR: !Ref VPC1ApplianceSubnet2CIDR
        VPC1PrivateSubnet1CIDR: !Ref VPC1PrivateSubnet1CIDR
        VPC1PrivateSubnet2CIDR: !Ref VPC1PrivateSubnet2CIDR
      TemplateURL: https://my-ab-demo.s3-ap-southeast-1.amazonaws.com/GWLB/single-vpc-cn/Nested-Stack-VPC1.yml
      TimeoutInMinutes: 15
      Tags:
        - Key: Name
          Value: AccessVPC

Outputs: 
    JumpServerPublicIP: # 堡垒机EIP,拼接登录字符串
      Description: JumpServer EIP in AccessVPC NATSubnet, single entry point for login
      Value: !GetAtt VPC01Stack.Outputs.VPC1JumpServerEIP
    LinuxAMI:
      Description: Latest ARM64 AMI ID used in tempalte
      Value: !Ref Arm64AmiId